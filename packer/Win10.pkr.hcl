source "vsphere-iso" "Win10" {
  CPUs                 = "${var.numcores}"
  RAM                  = "${var.memsize}"
  video_ram            = "${var.vramsize}"
  boot_command         = ["w"]
  boot_wait            = "${var.boot_wait}"
  communicator         = "winrm"
  cpu_cores            = "${var.numcores}"
  datacenter           = "${var.vcenter_datacenter}"
  datastore            = "${var.vcenter_datastore}"
  disk_controller_type = ["lsilogic-sas"]
  firmware             = "efi"
  floppy_files = [
    "configs/win11/autounattend.xml",
    "scripts/vmware_tools.ps1",
    "scripts/enable_winrm.ps1"
  ]
  guest_os_type       = "windows9_64Guest"
  host                = "${var.esx_host}"
  insecure_connection = true
  iso_checksum        = "${var.win10_iso_checksum}"
  iso_url             = "${var.win10_iso_url}"
  iso_paths           = ["[iso] vmtools/windows.iso"]
  network_adapters {
    network      = "${var.vcenter_network}"
    network_card = "vmxnet3"
  }
  password         = "${var.vcenter_password}"
  remove_cdrom     = true
  shutdown_timeout = "60m"
  winrm_password   = "${var.os_password}"
  winrm_timeout    = "1h"
  winrm_username   = "${var.os_user}"
  storage {
    disk_size             = "${var.disk_size}"
    disk_thin_provisioned = true
  }
  username            = "${var.vcenter_user}"
  vcenter_server      = "${var.vcenter_server}"
  vm_name             = "${var.win10_vm_name}"
  folder              = "exploit-forge-templates"
  convert_to_template = true
}

build {
  name    = "Win10"
  sources = ["source.vsphere-iso.Win10"]

  provisioner "windows-update" {}

  provisioner "powershell" {
    script = "scripts/chocolatey.ps1"
  }

  provisioner "windows-restart" {}
}