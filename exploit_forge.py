import subprocess
import os


def run_command(command):
    process = subprocess.Popen(
        command,
        stdout=subprocess.PIPE,
        stderr=subprocess.STDOUT,
    )

    for line in iter(process.stdout.readline, b""):
        print(line.decode().strip())


def packer_build():
    command = [
        "packer",
        "build",
        "-only=Win10.vsphere-iso.Win10,WinServ2022.vsphere-iso.WinServ2022",
        "-timestamp-ui",
        ".",
    ]
    run_command(command)


def terraform_apply():
    command = [
        "terraform",
        "apply",
        "-auto-approve",
    ]
    run_command(command)


def ansible_playbook():
    # Set environment variables
    os.environ["ANSIBLE_FORCE_COLOR"] = "true"
    command = [
        "ansible-playbook",
        "winlab.yml",
    ]
    run_command(command)


if __name__ == "__main__":
    # Get the current directory
    base_dir = os.getcwd()

    # Change directory to 'packer'
    os.chdir(os.path.join(base_dir, "packer"))
    packer_build()

    # Change directory to 'terraform'
    os.chdir(os.path.join(base_dir, "terraform"))
    terraform_apply()

    # Change directory to 'ansible'
    os.chdir(os.path.join(base_dir, "ansible"))
    ansible_playbook()
