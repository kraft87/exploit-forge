---
# Create Groups for Domain
- name: Create user group
  ansible.windows.win_group:
    name: Employees
    description: Employee Group
    state: present

- name: Create Guest group
  ansible.windows.win_group:
    name: Guests
    description: Guest group
    state: present

- name: Ensure the required NuGet package provider version is installed
  ansible.windows.win_shell: Find-PackageProvider -Name Nuget -ForceBootstrap -IncludeDependencies -Force

- name: Install XactiveDirectory package for OU creation
  community.windows.win_psmodule:
    name: ActiveDirectoryDSC
    accept_license: true
    force: true
    state: present

- name: Create OU for Staff
  ansible.windows.win_dsc:
    resource_name: ADOrganizationalUnit
    name: "Staff"
    path: "{{ dn_path }}"

- name: Create OU for  Admin
  ansible.windows.win_dsc:
    resource_name: ADOrganizationalUnit
    name: "Admins"
    path: "{{ dn_path }}"

- name: Create OU for Guests
  ansible.windows.win_dsc:
    resource_name: ADOrganizationalUnit
    name: "Guests"
    path: "{{ dn_path }}"

# Create multiple users for Domain and add to respective groups
- name: Create Guest User
  community.windows.win_domain_user:
    name: GuestUser
    firstname: Guest
    surname: User
    password: Password123!
    state: present
    path: "ou=Guests, {{ dn_path }}"
    groups:
      - Guests
      - Domain Guests
    domain_username: "{{ domain_admin_username }}"
    domain_password: "{{ domain_admin_password }}"
    domain_server: "{{ primary_domain_controller }}"

- name: Create administrator Account
  community.windows.win_domain_user:
    name: AbarnesAdmin
    firstname: Austin
    surname: Barnes
    password: Password123!
    state: present
    path: "ou=Admins, {{ dn_path }}"
    groups:
      - Employees
      - Domain Users
      - Domain Admins
      - Enterprise Admins
    domain_username: "{{ domain_admin_username }}"
    domain_password: "{{ domain_admin_password }}"
    domain_server: "{{ primary_domain_controller }}"

- name: Create Employee account John
  community.windows.win_domain_user:
    name: John
    firstname: John
    surname: Doe
    password: Password123!
    state: present
    path: "ou=Staff, {{ dn_path }}"
    groups:
      - Employees
      - Domain Users
    domain_username: "{{ domain_admin_username }}"
    domain_password: "{{ domain_admin_password }}"
    domain_server: "{{ primary_domain_controller }}"

- name: Create Employee account Sadie
  community.windows.win_domain_user:
    name: Sadie
    firstname: Sadie
    surname: Smith
    password: Password123!
    state: present
    path: "ou=Staff, {{ dn_path }}"
    groups:
      - Employees
      - Domain Users
    domain_username: "{{ domain_admin_username }}"
    domain_password: "{{ domain_admin_password }}"
    domain_server: "{{ primary_domain_controller }}"
