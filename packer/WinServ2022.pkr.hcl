source "vsphere-iso" "WinServ2022" {
  CPUs                 = "${var.numcores}"
  RAM                  = "${var.memsize}"
  boot_command         = ["w"]
  boot_wait            = "${var.boot_wait}"
  communicator         = "ssh"
  cpu_cores            = "${var.numcores}"
  datacenter           = "${var.vcenter_datacenter}"
  datastore            = "${var.vcenter_datastore}"
  disk_controller_type = ["pvscsi"]
  export {
    force            = true
    output_directory = "./build"
  }
  firmware            = "efi"
  floppy_files        = ["configs/autounattend.xml", "configs/sysprep-autounattend.xml", "scripts/install-vmware-tools-from-iso.ps1"]
  guest_os_type       = "windows9Server64Guest"
  host                = "${var.esx_host}"
  insecure_connection = true
  iso_checksum        = "${var.iso_checksum}"
  iso_paths           = ["[iso] vmtools/windows.iso"]
  iso_url             = "${var.iso_url}"
  network_adapters {
    network      = "VM Network"
    network_card = "vmxnet3"
  }
  notes                     = "${var.vm_notes}"
  password                  = "${var.vcenter_password}"
  remove_cdrom              = true
  shutdown_command          = "C:\\Windows\\system32\\Sysprep\\sysprep.exe /generalize /oobe /shutdown /unattend:A:\\sysprep-autounattend.xml"
  shutdown_timeout          = "60m"
  ssh_clear_authorized_keys = true
  ssh_password              = "${var.os_password}"
  ssh_timeout               = "1h"
  ssh_username              = "${var.os_user}"
  storage {
    disk_size             = "${var.disk_size}"
    disk_thin_provisioned = true
  }
  username       = "${var.vcenter_user}"
  vcenter_server = "${var.vcenter_server}"
  vm_name        = "${var.vm_name}"
  convert_to_template = true
}

build {
  name = "WinServ2022"

  sources = ["source.vsphere-iso.WinServ2022"]

  provisioner "windows-update" {
    search_criteria = "BrowseOnly=0 and IsInstalled=0"
    filters = [
      // "exclude:$_.Title -like '*Preview*'",
      "exclude:$_.InstallationBehavior.CanRequestUserInput",
      "include:$true",
    ]
  }

  provisioner "powershell" {
    scripts = ["scripts/adjustments.ps1", "scripts/cleanup.ps1"]
  }

  provisioner "windows-restart" {
    restart_timeout = "30m"
  }
}
